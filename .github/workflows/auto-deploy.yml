name: ğŸš€ Auto Deploy Episodes

on:
  push:
    branches: [ main ]
    paths:
      - 'assets/js/episodes-content.js'
      - 'assets/images/episodes/**'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

  # æ¯æ—¥å®šæ™‚ãƒã‚§ãƒƒã‚¯ï¼ˆæ–°ã—ã„Notionè¨˜äº‹ã®è‡ªå‹•æ¤œå‡ºç”¨ï¼‰
  schedule:
    - cron: '0 9 * * *'  # æ¯æ—¥9æ™‚ï¼ˆJST 18æ™‚ï¼‰

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: |
        npm install --production
        npm install sharp imagemin imagemin-webp

    - name: ğŸ–¼ï¸ Optimize images
      run: |
        node -e "
        const fs = require('fs');
        const path = require('path');
        const sharp = require('sharp');
        
        async function optimizeImages() {
          const episodeImagesDir = './assets/images/episodes';
          if (!fs.existsSync(episodeImagesDir)) return;
          
          const files = fs.readdirSync(episodeImagesDir);
          let optimized = 0;
          
          for (const file of files) {
            if (!/\.(jpg|jpeg|png)$/i.test(file)) continue;
            
            const inputPath = path.join(episodeImagesDir, file);
            const outputPath = path.join(episodeImagesDir, file.replace(/\.(jpg|jpeg|png)$/i, '.webp'));
            
            try {
              await sharp(inputPath)
                .webp({ quality: 85 })
                .toFile(outputPath);
              
              // å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ï¼ˆWebPã§ç½®ãæ›ãˆï¼‰
              fs.unlinkSync(inputPath);
              optimized++;
              console.log(\`âœ… Optimized: \${file} -> \${path.basename(outputPath)}\`);
            } catch (error) {
              console.warn(\`âš ï¸ Failed to optimize \${file}:\`, error.message);
            }
          }
          
          console.log(\`ğŸ‰ Optimized \${optimized} images\`);
        }
        
        optimizeImages().catch(console.error);
        "

    - name: ğŸ“Š Generate statistics
      run: |
        node -e "
        const fs = require('fs');
        
        // episodes-content.jsã‚’èª­ã¿è¾¼ã‚“ã§çµ±è¨ˆç”Ÿæˆ
        const content = fs.readFileSync('./assets/js/episodes-content.js', 'utf8');
        
        // ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        const europe2025Match = content.match(/europe2025:\s*{([^}]+)}/s);
        const europe2025_2Match = content.match(/europe2025_2:\s*{([^}]+)}/s);
        
        const europe2025Count = (europe2025Match?.[1] || '').split(/\d+:/).length - 1;
        const europe2025_2Count = (europe2025_2Match?.[1] || '').split(/\d+:/).length - 1;
        const totalCount = europe2025Count + europe2025_2Count;
        
        // ç”»åƒæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        const episodeImagesDir = './assets/images/episodes';
        let imageCount = 0;
        if (fs.existsSync(episodeImagesDir)) {
          imageCount = fs.readdirSync(episodeImagesDir).length;
        }
        
        // çµ±è¨ˆã‚’JSONã§å‡ºåŠ›
        const stats = {
          totalEpisodes: totalCount,
          europe2025Episodes: europe2025Count,
          europe2025_2Episodes: europe2025_2Count,
          totalImages: imageCount,
          lastUpdated: new Date().toISOString()
        };
        
        fs.writeFileSync('./assets/js/site-stats.js', 
          \`// ã‚µã‚¤ãƒˆçµ±è¨ˆï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰\nconst SITE_STATS = \${JSON.stringify(stats, null, 2)};\`
        );
        
        console.log('ğŸ“Š Site Statistics:');
        console.log(\`   Total Episodes: \${totalCount}\`);
        console.log(\`   Europe 2025: \${europe2025Count}\`);
        console.log(\`   Europe 2025â‘¡: \${europe2025_2Count}\`);
        console.log(\`   Total Images: \${imageCount}\`);
        "

    - name: ğŸ” Validate episodes content
      run: |
        node -e "
        try {
          require('./assets/js/episodes-content.js');
          console.log('âœ… episodes-content.js is valid');
        } catch (error) {
          console.error('âŒ episodes-content.js validation failed:', error.message);
          process.exit(1);
        }
        "

    - name: ğŸŒ Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/main'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        exclude_assets: |
          node_modules/**
          .github/**
          notion-*.js
          export-*.js
          package*.json
          *.md

    - name: ğŸ“± Send notification
      if: success()
      run: |
        echo "ğŸ‰ ã‚µã‚¤ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼"
        echo "ğŸŒ URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        
    - name: ğŸ’¬ Comment on commit
      if: github.event_name == 'push'
      uses: actions/github-script@v7
      with:
        script: |
          const stats = require('./assets/js/site-stats.js');
          
          github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: \`ğŸš€ **è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†**
            
ğŸ“Š **ã‚µã‚¤ãƒˆçµ±è¨ˆ:**
- ç·ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ•°: **\${stats.totalEpisodes}**
- ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘2025: \${stats.europe2025Episodes}è©±
- ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘2025â‘¡: \${stats.europe2025_2Episodes}è©±  
- ç”»åƒæ•°: \${stats.totalImages}æš

ğŸŒ **å…¬é–‹URL:** https://\${context.repo.owner}.github.io/\${context.repo.repo}/

â° æ›´æ–°æ™‚åˆ»: \${new Date().toLocaleString('ja-JP')}\`
          });

  # æ–°ã—ã„Notionè¨˜äº‹ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œæ™‚ï¼‰
  check-new-episodes:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ğŸ” Check for new Notion episodes
      env:
        NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
      run: |
        node -e "
        console.log('ğŸ” æ–°ã—ã„Notionè¨˜äº‹ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...');
        console.log('ğŸ“ ã“ã®æ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™');
        
        // TODO: Notion APIã§æ–°ã—ã„è¨˜äº‹ã‚’æ¤œå‡º
        // TODO: è‡ªå‹•ã§è¨˜äº‹ã‚’å¤‰æ›ãƒ»è¿½åŠ 
        // TODO: è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆ&ãƒ—ãƒƒã‚·ãƒ¥
        "

    - name: ğŸš¨ Alert if new episodes found
      run: |
        echo "::warning::æ–°ã—ã„ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚æ‰‹å‹•ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚"